<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="codelover" />










<meta name="description" content="一只打算吃软饭的软狗">
<meta name="keywords" content="一只打算吃软饭的软狗">
<meta property="og:type" content="website">
<meta property="og:title" content="codelover的异想天开">
<meta property="og:url" content="http://codelover.link/page/2/index.html">
<meta property="og:site_name" content="codelover的异想天开">
<meta property="og:description" content="一只打算吃软饭的软狗">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="codelover的异想天开">
<meta name="twitter:description" content="一只打算吃软饭的软狗">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://codelover.link/page/2/"/>





  <title>codelover的异想天开</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">codelover的异想天开</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/C#为匿名类型定义局部函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/C#为匿名类型定义局部函数/" itemprop="url">C#为匿名类型定义局部函数</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet/" itemprop="url" rel="index">
                    <span itemprop="name">dotnet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>可能是因为我们都习惯于明确定义，一般而言,日常我们很少使用匿名对象。<br>然而对于实现那些短时间存在的、并不在应用程序逻辑中起支配地位的类型，使用匿名对象就是一个不错的选择了另一个方面，可能也是因为匿名类型的生命周期无法跨越包含改类型的方法，导致很多人觉得匿名对象并不好用，因为其无法在多个方法之间传递。</p>
<p>这样说并不准确。我们完全可以为匿名类型编写泛型方法。不过若是如此，我们便不能在泛型类型方法中处理任何特殊的元素或者编写任何的专门逻辑。<br>下面我们就来写一个简单的示例，示例功能：返回集合中与待查找对象相等的所有元素。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;T&gt; <span class="title">FindValue</span>(<span class="params">IEnumerable&lt;T&gt; enumerable, T <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (T element <span class="keyword">in</span> enumerable)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (element.Equals(<span class="keyword">value</span>))</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> element;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方法是可以配合匿名类型使用的，但是这个方法本质上其实就是一个泛型方法，并不了解匿名类型的信息。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/C#技巧避免修改绑定变量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/C#技巧避免修改绑定变量/" itemprop="url">dotnet lmabda避免修改绑定变量</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet/" itemprop="url" rel="index">
                    <span itemprop="name">dotnet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先看一段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#region test1 闭包</span><br><span class="line"></span><br><span class="line">        public static void test1()</span><br><span class="line">        &#123;</span><br><span class="line">            int index = 0;</span><br><span class="line">            Func&lt;IEnumerable&lt;int&gt;&gt; sequence =()=&gt;GetEnumrableInt(index);</span><br><span class="line"></span><br><span class="line">            index = 20;</span><br><span class="line">            foreach(int n in sequence())</span><br><span class="line">                Console.WriteLine(n);</span><br><span class="line"></span><br><span class="line">            Console.WriteLine(&quot;Done&quot;);</span><br><span class="line"></span><br><span class="line">            index = 100;</span><br><span class="line">            foreach (int n in sequence())</span><br><span class="line">                Console.WriteLine(n);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public static IEnumerable&lt;int&gt; GetEnumrableInt(int index)</span><br><span class="line">        &#123;</span><br><span class="line">            List&lt;int&gt; l = new List&lt;int&gt;();</span><br><span class="line">            for(int i=index;i&lt;index+30;i++)</span><br><span class="line">            &#123;</span><br><span class="line">                l.Add(i);</span><br><span class="line">            &#125;</span><br><span class="line">            return l;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        #endregion</span><br></pre></td></tr></table></figure>
<p>上面一坨代码演示了在闭包中使用了外部变量，随即又在外部修改了这些变量的情况，得到的结果是输出了20-50的数，然后又输出了100-130之间的数。这种行为有点诡异，但是确实有存在的意义…(书本这样说的，我到觉得很少会用到。)</p>
<p>为了将查询表达式转换成可执行代码，C#编译器做了很多工作。一般而言，C#编译器将查询和lambda表达式转换成 “静态委托”、”实例委托” 或 “闭包”。编译器将根据lambda表达式中的代码选择一种实现方式。选择哪种方式依赖于lambda表达式的主体（body）。这看上去似乎是一些语言上的实现细节，但它却会显著地影响到我们的代码。编译器选择何种实现将可能导致diamante行为发生微妙的变化。</p>
<p>并不是任何的lambda表达式都会生成同样结构的代码。</p>
<p>对于编译器来说，最简单的一种行为是为以下形式的代码生成委托。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//我们的lambda表达式</span><br><span class="line">        public static void test2()</span><br><span class="line">        &#123;</span><br><span class="line">            int[] someNum = &#123;0,1,2,3,4,5,6,7,8,9,10 &#125;;</span><br><span class="line"></span><br><span class="line">            IEnumerable&lt;int&gt; ans = from n in someNum</span><br><span class="line">                                   select n * n;</span><br><span class="line"></span><br><span class="line">            foreach (int i in ans)</span><br><span class="line">                Console.WriteLine(i);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>编译器将使用静态委托来实现n*n的lambda表达式，其为上面代码生成的代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> //编译器为我们的lambda生成的代码</span><br><span class="line">#region 等价于 test2()</span><br><span class="line">private static int HiddenFunc(int n)</span><br><span class="line">&#123;</span><br><span class="line">    return n * n;</span><br><span class="line">&#125;</span><br><span class="line">//静态委托</span><br><span class="line">private static Func&lt;int, int&gt; HiddenDelegate;</span><br><span class="line"></span><br><span class="line">public void test2_1()</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    int[] someNum = &#123; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10 &#125;;</span><br><span class="line"></span><br><span class="line">    if(HiddenDelegate==null)</span><br><span class="line">    &#123;</span><br><span class="line">        HiddenDelegate = new Func&lt;int, int&gt;(HiddenFunc);</span><br><span class="line">    &#125;</span><br><span class="line">    IEnumerable&lt;int&gt; ans = someNum.Select&lt;int, int&gt;(HiddenDelegate);</span><br><span class="line"></span><br><span class="line">  foreach(int i in ans)</span><br><span class="line">      Console.WriteLine(i);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">#endregion</span><br></pre></td></tr></table></figure></p>
<p>这个lambda表达式主体部分并没有访问任何的实例变量或者局部变量。lambda表达式仅仅访问了它的参数。对于这种情况，C#编译器将创建一个静态方法，作为委托的目标。这也是编译器执行的最简单的一种处理方式。若表达式可以通过私有的静态方法实现，那么编译器将生成该私有的静态方法以及相对应的委托定义。对于上面的代码例子中的情况以及仅访问了静态变量的表达式，编译器都会采用这样的方案。</p>
<p>接下来介绍另一种较为简单的情况：<br>lambda表达式需要访问类型的实例变量，但无需访问外层方法中的局部变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">    public class ModFilter</span><br><span class="line">    &#123;</span><br><span class="line">        private readonly int modules;</span><br><span class="line"></span><br><span class="line">        public ModFilter(int mod)</span><br><span class="line">        &#123;</span><br><span class="line">            modules = mod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)</span><br><span class="line">        &#123;</span><br><span class="line"></span><br><span class="line">            return from n in sequence</span><br><span class="line">                   where n % modules == 0 //新添加的表达式</span><br><span class="line">                   select n * n;  //和前面的例子是一样的</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/* </span><br><span class="line"></span><br><span class="line">在这种情况下，编译器将为表达式创建一个实例方法来包装该委托。</span><br><span class="line">其基本概念和前一种情况一致，只是这里使用了实例方法，以便读取并修改当前对象的状态。</span><br><span class="line">与静态委托的例子一样，这里编译器将把lambda表达式转换成我们熟悉的代码。其中包含委托的定义以及方法调用。</span><br><span class="line">如下：</span><br><span class="line"></span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public class ModFilter_Other</span><br><span class="line">    &#123;</span><br><span class="line">        private readonly int modules;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //实例方法</span><br><span class="line">        private bool WhereClause(int n)</span><br><span class="line">        &#123;</span><br><span class="line">            return ((n%this.modules) ==0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        private static int SelectClause(int n)</span><br><span class="line">        &#123;</span><br><span class="line">            return n * n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        private static Func&lt;int, int&gt; SelectDelegate;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public ModFilter_Other(int mod)</span><br><span class="line">        &#123;</span><br><span class="line">            modules = mod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)</span><br><span class="line">        &#123;</span><br><span class="line">            if(SelectDelegate==null)</span><br><span class="line">            &#123;</span><br><span class="line">                SelectDelegate = new Func&lt;int, int&gt;(SelectClause);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return sequence.Where&lt;int&gt;(</span><br><span class="line">                new Func&lt;int, bool&gt;(this.WhereClause)).</span><br><span class="line">                Select&lt;int, int&gt;(SelectClause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>概括来说便是：lambda表达式中的代码访问了对象实例中的成员变量，那么编译器将生成实例方法来表示lambda表达式中的代码。其实这并没有什么奇特之处——编译器省去了我们的一些代码输入工作，代码也变得整洁很多，本质来说这还是普通的方法调用。</p>
<p>不过若是lambda表达式中访问到了外部方法中的局部变量或者方法参数，那么编译器将帮你完成很多工作。</p>
<p>这里会用到闭包。编译器将生成一个私有的嵌套类型，以便为局部变量实现闭包。</p>
<p>局部变量必须传入到实现了lambda表达式主体部分的委托里。</p>
<p>此外，所有由该lambda表达式执行的对这些局部变量所作的修改都必须能够在外部访问到。</p>
<p>当然，代码中内层和外层中共享的可能不止有一个变量，也可能不止一个的查询表达式。</p>
<p>我们来修改一下该实例方法，让其访问一个局部变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">		  public class ModFilter</span><br><span class="line">		  &#123;</span><br><span class="line">		        private readonly int modules;</span><br><span class="line">		</span><br><span class="line">		        public ModFilter(int mod)</span><br><span class="line">		        &#123;</span><br><span class="line">		            modules = mod;</span><br><span class="line">		        &#125;</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		        public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)</span><br><span class="line">		        &#123;</span><br><span class="line">		            int numValues = 0;</span><br><span class="line">		</span><br><span class="line">		            return from n in sequence</span><br><span class="line">		                   where n % modules == 0 //新添加的表达式</span><br><span class="line">		                   select n * n / ++ numValues; //访问局部变量</span><br><span class="line">		        &#125;</span><br><span class="line">	      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意，select字句需要访问numValues这个局部变量。编译器为了创建这个闭包，需要使用嵌套类型来实现你所需要的行为。下面展示的是编译器为你生成的代码。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> 	 public class ModFilter</span><br><span class="line">     &#123;</span><br><span class="line">        private sealed class Closure</span><br><span class="line">        &#123;</span><br><span class="line">            public ModFilter outer;</span><br><span class="line"></span><br><span class="line">            public int numValues;</span><br><span class="line"></span><br><span class="line">            public int SelectClause(int n)</span><br><span class="line">            &#123;</span><br><span class="line">                return ((n * n) / ++this.numValues);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        private readonly int modules;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //实例方法</span><br><span class="line">        private bool WhereClause(int n)</span><br><span class="line">        &#123;</span><br><span class="line">            return ((n % this.modules) == 0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public ModFilter(int mod)</span><br><span class="line">        &#123;</span><br><span class="line">            modules = mod;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        public IEnumerable&lt;int&gt; FindValues(IEnumerable&lt;int&gt; sequence)</span><br><span class="line">        &#123;</span><br><span class="line">            Closure c = new Closure();</span><br><span class="line">            c.outer = this;</span><br><span class="line">            c.numValues = 0;</span><br><span class="line"></span><br><span class="line">            return sequence.Where&lt;int&gt;(</span><br><span class="line">                new Func&lt;int, bool&gt;(this.WhereClause)).</span><br><span class="line">                Select&lt;int, int&gt;(c.SelectClause);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>在上面这段代码中，编译器专门创建了一个嵌套类，用来容纳所有将在lambda表达式中访问或修改的变量。实际上，这些局部变量将完全被嵌套类的字段所代替。lambda表达式内部的代码以及表达式外部(但仍在当前方法内)的代码访问的均是同一个字段，lambda表达式中的逻辑也被编译成了内部类的一个方法。</p>
<p>对于lambda表达式中将要用到的外部方法的参数，编译器也会以对待局部变量的方式实现：编译器将这些参数复制到表示该闭包的嵌套类中。</p>
<p>回到最开始的那个示例，这是我们应该可以理解这种看似怪异的行为了。变量index在传入闭包后，但在查询开始执行前曾被外部代码修改。也就是说，你修改了闭包的内部状态，然后还期待其能够回到从前的状态开始执行，显然这是不可能实现的。</p>
<p>考虑到延迟执行中的交互以及编译器实现闭包的方式，修改查询与外部代码之间绑定的变量将可能会引发错误的行为。<br>因此，我们应该尽量避免在方法中修改哪些将要传入到闭包中，并将在闭包中使用的变量。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/C#避免在函数或者操作中抛出异常/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/C#避免在函数或者操作中抛出异常/" itemprop="url">C#避免在函数或者操作中抛出异常</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet/" itemprop="url" rel="index">
                    <span itemprop="name">dotnet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="C-避免在函数或者操作中抛出异常"><a href="#C-避免在函数或者操作中抛出异常" class="headerlink" title="C#避免在函数或者操作中抛出异常"></a>C#避免在函数或者操作中抛出异常</h1><h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>如某个场景下，你的函数或操作需要操作一个序列的对象，且在处理的过程中抛出了异常。这时如果没有一些状态记录之类的数据，我们不了解已经处理了多少的数据，也不知道应该采用怎么样的策略回滚，因此根本无法返回到之前的状态。<br>我们看一下下面的一个代码：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> allEmp = FindAllEmployees();</span><br><span class="line">allEmp.ForEach(e =&gt; e.MonthlySalary *=<span class="number">1.05</span>M);</span><br></pre></td></tr></table></figure>
<p>这样的代码看起来没什么问题。可是某一天，这个程序运行时抛出了异常。抛出异常的位置可能未知，导致部分员工得到了加薪，另外的一些员工却没有。结果是除了人工检查数据，我们已经没有办法重新找回丢失的状态。</p>
<p>这样的代码修改元素的方式导致发生了上面的问题。这段代码并没有遵循“强异常安全保证”规则。换而言之，在运行时遇到错误，我们无法得知具体发生了什么，没有发生什么。</p>
<h3 id="原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。"><a href="#原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。" class="headerlink" title="原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。"></a>原则：如果我们能保证当方法无法完成时，程序的状态不会发生改变，这样的问题就不会发生。</h3><p>我们有几种方法都可以实现这样的需求，但是每种方法都有各自的优势和风险。</p>
<h2 id="在函数-操作中抛出异常"><a href="#在函数-操作中抛出异常" class="headerlink" title="在函数/操作中抛出异常"></a>在函数/操作中抛出异常</h2><p>显而易见的，不是所有的方法都会遇到这样的问题（异常导致状态丢失）。很多时候我们只是检查了一下序列中的元素，访问之后并不会修改其中的元素。这类的行为我们其实并不需要太过于小心。现在我们回到最开始的地方，对于上面的场景（为每位员工加薪百分之五），如果我们想遵循“强异常安全保证”原则，那应该如何修改这个方法呢？</p>
<h4 id="第一种异常：获取数据的时候异常"><a href="#第一种异常：获取数据的时候异常" class="headerlink" title="第一种异常：获取数据的时候异常"></a>第一种异常：获取数据的时候异常</h4><p>在上面的例子中，即使FindAllEmployees()函数抛出异常，导致我们无法正确让员工加薪。虽然这样的情况并不是导致我们的数据产生问题，但是该加薪的大家没有得到加薪，这是一个多么沮丧的事情呢。</p>
<h4 id="解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees-方法），让其永远不会抛出异常。"><a href="#解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees-方法），让其永远不会抛出异常。" class="headerlink" title="解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。"></a>解决方法：重写前面以lambda表达式给出的操作方法（即FindAllEmployees()方法），让其永远不会抛出异常。</h4><p>很多时候，我们在开始修改数据之前，先校验数据的合法性以及剔除错误数据（如果允许剔除的话）并不是非常困难。我们是可以采取这样的方法来实现我们的目的。不过在这里的话，我们就必须严格处理操作方法，使得它能满足所有情况下的需求。</p>
<h4 id="第二种异常：lambda表达式中操作数据异常"><a href="#第二种异常：lambda表达式中操作数据异常" class="headerlink" title="第二种异常：lambda表达式中操作数据异常"></a>第二种异常：lambda表达式中操作数据异常</h4><p>同样是上面的例子，如果我们在执行加薪操作的时候，提升了那些已经离职的员工薪资导致了异常，使得程序中断，状态丢失。这样的情况，我们在执行加薪操作前先过滤掉已离职的员工便是一种正确的做法。</p>
<h4 id="解决方法：操作数据前通过校验过滤后再执行操作"><a href="#解决方法：操作数据前通过校验过滤后再执行操作" class="headerlink" title="解决方法：操作数据前通过校验过滤后再执行操作"></a>解决方法：操作数据前通过校验过滤后再执行操作</h4><p>如：<br>allEmp.Where(emp=&gt;emp.Active).ForEach(e =&gt; e.MonthlySalary *=1.05M);</p>
<h4 id="第三种异常：执行操作的时候抛出异常"><a href="#第三种异常：执行操作的时候抛出异常" class="headerlink" title="第三种异常：执行操作的时候抛出异常"></a>第三种异常：执行操作的时候抛出异常</h4><p>有时候，我们根本无法保证处理方法的时候会不会抛出异常。这个时候就必须采取一些代价更加昂贵的处理方法了。</p>
<h4 id="解决方法：创建副本尝试执行操作，副本无误后执行真正操作"><a href="#解决方法：创建副本尝试执行操作，副本无误后执行真正操作" class="headerlink" title="解决方法：创建副本尝试执行操作，副本无误后执行真正操作"></a>解决方法：创建副本尝试执行操作，副本无误后执行真正操作</h4><p>我们在编写这类代码的时候，应该考虑抛出异常之后的处理方案。这就意味着，我们的操作应该先在原数据副本上执行，随后仅在操作成功之后再将其替换原有的数据。<br>如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var updatas = (from e in allEmp </span><br><span class="line">              select new Emp</span><br><span class="line">              &#123;</span><br><span class="line">                  EmpID=e.EmpID,</span><br><span class="line">                  .....</span><br><span class="line">                  MonthlySalary =e.MonthlySalary *=1.05M</span><br><span class="line">              &#125;).ToList();</span><br><span class="line"></span><br><span class="line">allEmp = updatas;</span><br></pre></td></tr></table></figure>
<p>但是这样的修改也引发了其他的问题：代码量增加了，同时生成副本也消耗了大量的资源。这样的做法也有一个好处，我们在操作副本数据时遇到异常之后，有充分的”空间”来处理这些数据。</p>
<p>实际中，这意味着我们让查询表达式返回了新序列，而不是去修改原先序列中的元素。这样的话，我们在尝试完成所有的操作的同时，即使失败了，也不会影响到我们程序的原有状态。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/CLR-GC-Handle-Table/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/CLR-GC-Handle-Table/" itemprop="url">CLR 手动监控和控制对象的生存周期</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet/" itemprop="url" rel="index">
                    <span itemprop="name">dotnet</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>CLR为每个 ApDomain 都提供了一个 <strong>GC句柄表（GC Handle table）</strong>，允许应用程序监视或者手动控制对象的生存期。这个表在 ApDomain 创建之初是空白的。</p>
<p>表中每个记录项都包含一下两种信息：</p>
<p>对托管堆中的一个对象的引用，以及之初如何监视或者控制对象的标志（flag）。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/Can't_install_Preview2_on_fresh_VS2015_Update3_Installation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/Can't_install_Preview2_on_fresh_VS2015_Update3_Installation/" itemprop="url">Microsoft .NET Core 1.0.0 VS 2015 Tooling Preview 2 0x80070003</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet-core/" itemprop="url" rel="index">
                    <span itemprop="name">dotnet core</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近安装Microsoft .NET Core 1.0.0 VS 2015 Tooling Preview 2实在有点曲折，忍不住写个文章来讲这货的坑爹之旅了。</p>
<p>一般我们在<a href="https://www.microsoft.com/net/download" target="_blank" rel="noopener">.NET Downloads</a> 下载回来的Microsoft .NET Core 1.0.0 VS 2015 Tooling Preview 2是一个简易安装包。</p>
<p>它在安装过程中会不断去网络请求需要的msi文件，美名曰：在线安装。</p>
<p>然而在我国的国情以及我国网络运营商的衬托下，在线安装这种东西实在不可恭维。</p>
<p>本来网络稳定，在线安装 这种鬼也还算能用，不过最近微软爸爸不知道为嘛了，.net core相关安装包的下载地址全线失效。<br>如<a href="https://download.microsoft.com/download/0/A/3/0A372822-205D-4A86-BFA7-084D2CBE9EDF/DotNetCore.1.0.1-SDK.1.0.0.Preview2-003133-x64.exe" target="_blank" rel="noopener">DotNetCore.1.0.1-SDK.1.0.0.Preview2-003133-x64.exe</a>，直接出502 Bad Gateway。</p>
<p>这个还能用迅雷或者命令行下载回来，但是DotNetCore.1.0.1-SDK.1.0.0.Preview2这货安装过程中需要的一下msi安装包，就死活下不回来了。</p>
<h4 id="安装过程报错：0x80070003-系统找不到需要的文件。"><a href="#安装过程报错：0x80070003-系统找不到需要的文件。" class="headerlink" title="安装过程报错：0x80070003 系统找不到需要的文件。"></a>安装过程报错：0x80070003 系统找不到需要的文件。</h4><p>此处已确认是微软爸爸的bug了。<a href="https://github.com/aspnet/Tooling/issues/655" target="_blank" rel="noopener">issue在这里</a></p>
<h4 id="分析log"><a href="#分析log" class="headerlink" title="分析log"></a>分析log</h4><p>我们去看安装失败的log，能看到类似下面的log：</p>
<p>Error 0x80072efd: Failed attempt to download URL: ‘<a href="https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi&#39;" target="_blank" rel="noopener">https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi&#39;</a> to: ‘C:\Users\cneuss\AppData\Local\Temp{C307771D-8D9A-45B5-B514-B6CA69C0C6E2}\ANCM_IISExpress_x64’</p>
<p>很明显这个操作从</p>
<p><a href="https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi" target="_blank" rel="noopener">https://download.microsoft.com/download/A/3/8/A38489F3-9777-41DD-83F8-2CBDFAB2520C/packages/ancm_iis_express_x64_en_rc2_39.msi</a></p>
<p>上面下载ancm_iis_express_x64_en_rc2_39.msi文件。</p>
<p>然而我们点击进去，看到这个同样的问题：502 Bad Gateway。</p>
<p>安装到这里，已经GG了。</p>
<p>不过既然知道是因为下载文件的问题了，那么解决办法也应运而生了。</p>
<p>我们完全手动下载文件（用迅雷或者别的下载工具），发布在本地，改hosts地址让下载请求直接从本地下载文件。</p>
<p>这个方案听起来是没有任何的问题的，我也成功使用迅雷把无法下载的文件下载到本地了。然而在改host地址这里卡住了。</p>
<p>不知道为嘛，无论我把<a href="download.microsoft.com">download.microsoft.com</a>指向怎么改，也无法把请求重定向到本地。</p>
<p>后来认真看了下安装log，发现所以的下载操作都是把文件下载到 C:\Users\cneuss\AppData\Local\Temp 目录（具体目录看log文件内容）下的临时路径，报错是系统找不到需要的文件。</p>
<p>那么，我们手动把需要的文件放到对应的位置，问题也就解决了。</p>
<p>所以，为了清晰找到临时路径，安装之前先把“C:\Users\cneuss\AppData\Local\Temp”的文件清空，然后点击安装包。</p>
<p>很快可以在temp路径下看到冒出来的{xxxxxxxxxxxxx}文件夹，然后迅速把我们通过迅雷下载回来的文件仍到这个目录底下。</p>
<p>迅速操作的原因是，在线安装包正在下载所需要的文件，如：ancm_iis_express_x64_en_rc2_39.msi，我们要在下载超时之前把文件应该在的位置，这样的话即使下载没拿到文件，安装程序还是可以拿我们的文件去执行安装。</p>
<p>别的就是不断尝试，看缺少那个msi手动下哪个msi的事情了。</p>
<h4 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h4><p>最后，根据log文件，还发现了一个更简单的方法：</p>
<p>在DotNetCore.1.0.1-SDK.1.0.0.Preview2-003133-x64.exe的同级目录下新建packages文件夹，把上面无法在线下载到的msi仍进去，然后就一路绿灯了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/CodeSmith-MySQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/CodeSmith-MySQL/" itemprop="url">CodeSmith for MySQL template</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CodeSmith/" itemprop="url" rel="index">
                    <span itemprop="name">CodeSmith</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对于.NET平台上的代码生成器来说，codesmith是一个非常好的选择。</p>
<p><br><br>以前在学院实验室用的都是SQL server数据库，老师给的一套codesmith模板用来生成model/DAL/BLL很是方便。<br><br><br>不过后来放弃SQL server 投入MySQL之后，刚开始都是手写SQL，还是很痛苦的。<br><br><br>再后来又去找MySQL codesmith模板,这个对应的资料就不多了。不过最后还是找到了一套不错的，凑合能用。起初也懒，codesmith语法不熟，就没想过去修改一下了。<br><br> 最近又要用到这套东西，于是决定还是去修改一番，更便于使用。</p>
<p>这个文章就主要讲一下修改过程，顺便说一下codesmith的简单语法。</p>
<p>先说一下操作步骤：</p>
<p>把模板的文件夹扔到codesmith模板文件的路径下，接着打开Codesmith，找到刚扔过去的文件夹，选择Main.cst,右键-execute-选择对应的MySQL库-选中表。<br><br>（注：codesmith连接MySQL有问题的话，<br><br>移步这里解决 <a href="http://codelover.link/2016/02/25/CodeSmith%E8%BF%9E%E6%8E%A5MySQL%E6%8A%A5%E9%94%99%E2%80%9C%E6%89%BE%E4%B8%8D%E5%88%B0%E8%AF%B7%E6%B1%82%E7%9A%84%20.Net%20Framework%20Data%20Provider%E3%80%82%E5%8F%AF%E8%83%BD%E6%B2%A1%E6%9C%89%E5%AE%89%E8%A3%85%E3%80%82%E2%80%9D%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/">CodeSmith 连接MySQL数据库报“can’t find .net framework data provider”</a>)</p>
<p>如下图：<br><img src="http://a1.qpic.cn/psb?/V13bZOxq1m5DxB/1XlywVcAyPW6y*6sO1QU.gkuidIqPkx.f70JsaijlU0!/b/dIwBAAAAAAAA&amp;bo=MQIcAjECHAIDCSw!&amp;rf=viewer_4" alt="1"></p>
<p>然后点击Generate就能顺利生成model/dal/bll了。</p>
<p>生成代码结构如下：<br><img src="http://a3.qpic.cn/psb?/V13bZOxq1m5DxB/ikI1fSxAYklZgi1PmtPVTQqpHcZ0KTQHgN7LrPJaKNo!/b/dG4AAAAAAAAA&amp;bo=fgLGAH4CxgADCSw!&amp;rf=viewer_4" alt="2"></p>
<p></p><p>这样操作没什么问题，顺利生成了我们要的model/dal/bll了，然后….我懒嘛。<br>每次都要把表一个个选一次，麻不麻烦啊。然后就想了，能不能改一下模板呢。于是便开始google相关资料了。找到了几个相关文章，参考这就开始改造了。<br>先看看原来的Main.cst里面写了撒。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;%@ CodeTemplate Language=&quot;C#&quot; ResponseEncoding=&quot;UTF-8&quot; </span><br><span class="line">TargetLanguage=&quot;Text&quot; Src=&quot;&quot; Inherits=&quot;&quot; Debug=&quot;False&quot; </span><br><span class="line">Description=&quot;Template description here.&quot; </span><br><span class="line"> Output=&quot;None&quot;%&gt;</span><br><span class="line">&lt;%@ Register Name=&quot;Models&quot; Template=&quot;DBMad.Models.cst&quot; </span><br><span class="line">	MergeProperties=&quot;False&quot; ExcludeProperties=&quot;&quot; %&gt;	</span><br><span class="line">&lt;%@ Register Name=&quot;DAL&quot; Template=&quot;DBMad.DAL.cst&quot; </span><br><span class="line">MergeProperties=&quot;False&quot; ExcludeProperties=&quot;&quot; %&gt; </span><br><span class="line">&lt;%@ Register Name=&quot;BLL&quot; Template=&quot;DBMad.BLL.cst&quot; </span><br><span class="line">MergeProperties=&quot;False&quot; ExcludeProperties=&quot;&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ Property Name=&quot;SourceTable&quot; </span><br><span class="line">Type=&quot;SchemaExplorer.TableSchema&quot; Optional=&quot;False&quot;%&gt;</span><br><span class="line">&lt;%@ Property Name=&quot;RootNamespace&quot; Default=&quot;Net.Itcast.CN&quot; </span><br><span class="line">Type=&quot;System.String&quot; Optional=&quot;False&quot;%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ Assembly Name=&quot;SchemaExplorer&quot; %&gt;</span><br><span class="line">&lt;%@ Assembly Name=&quot;System.Data&quot; %&gt;</span><br><span class="line">&lt;%@ Import Namespace=&quot;SchemaExplorer&quot; %&gt;</span><br><span class="line">&lt;%@ Import Namespace=&quot;System.Data&quot; %&gt;</span><br><span class="line">&lt;script runat=&quot;template&quot;&gt;</span><br><span class="line">	private string _outputDirectory = String.Empty;</span><br><span class="line">	[Editor(typeof(System.Windows.Forms.Design.FolderNameEditor), </span><br><span class="line">	typeof(System.Drawing.Design.UITypeEditor))] </span><br><span class="line">	[Description(&quot;The directory to output the results to.&quot;)]</span><br><span class="line">	public string OutputDirectory </span><br><span class="line">	&#123;</span><br><span class="line">		get</span><br><span class="line">		&#123;		</span><br><span class="line">			return _outputDirectory;</span><br><span class="line">		&#125;</span><br><span class="line">		set</span><br><span class="line">		&#123;</span><br><span class="line">			if (value != null &amp;&amp; !value.EndsWith(&quot;\\&quot;))</span><br><span class="line">			&#123;</span><br><span class="line">				value += &quot;\\&quot;;</span><br><span class="line">		    &#125;</span><br><span class="line">			_outputDirectory = value;</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这一段基本就是在声明选项以及引用命名空间，表现出来的便是我们看到的下图：</p>
<p><img src="http://a1.qpic.cn/psb?/V13bZOxq1m5DxB/1XlywVcAyPW6y*6sO1QU.gkuidIqPkx.f70JsaijlU0!/b/dIwBAAAAAAAA&amp;bo=MQIcAjECHAIDCSw!&amp;rf=viewer_4" alt="1"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    Models model = this.Create&lt;Models&gt;();</span><br><span class="line">	model.ModelsNamespace = this.RootNamespace+&quot;.Model&quot;;</span><br><span class="line">	model.TargetTable = this.SourceTable;</span><br><span class="line">	model.RenderToFile(this.OutputDirectory+&quot;Model/&quot;+model.GetFileName(),true);</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">   DAL dal = this.Create&lt;DAL&gt;();</span><br><span class="line">   dal.TargetTable = this.SourceTable;</span><br><span class="line">   dal.ModelsNamespace = model.ModelsNamespace;</span><br><span class="line">   dal.DALClassNameSurfix = &quot;DAL&quot;;</span><br><span class="line">   dal.DALNamespace =this.RootNamespace+&quot;.DAL&quot;;</span><br><span class="line">   dal.RenderToFile(this.OutputDirectory+&quot;DAL/&quot;</span><br><span class="line">   +dal.GetFileName(),true);</span><br><span class="line"></span><br><span class="line">   BLL bll = this.Create&lt;BLL&gt;();</span><br><span class="line">   bll.ModelsNamespace = model.ModelsNamespace;</span><br><span class="line">   bll.DALClassNameSurfix = dal.DALClassNameSurfix;</span><br><span class="line">   bll.DALNamespace = dal.DALNamespace;</span><br><span class="line">   bll.BLLClassNameSurfix = &quot;BLL&quot;;</span><br><span class="line">   bll.BLLNamespace = this.RootNamespace+&quot;.BLL&quot;;</span><br><span class="line">   bll.TargetTable = this.SourceTable;</span><br><span class="line">   bll.RenderToFile(this.OutputDirectory+&quot;BLL/&quot;</span><br><span class="line">   +bll.GetFileName(),true);</span><br><span class="line"></span><br><span class="line">   Response.Write(&quot;ok,see &quot;+this.OutputDirectory);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<p>这一段就是我们点击Generate之后执行的代码，基本功能就是调用<br>DBMad.Models.cst,DBMad.DAL.cst,DBMad.BLL.cst。<br>因为在上面声明数据源的时候，使用了SchemaExplorer.TableSchema，导致我们选择表的时候不能多选。代码如下：</p>
<p>&lt;%@ Property Name=”SourceTable” Type=”SchemaExplorer.TableSchema” Optional=”False”%&gt;</p>
<p>这样一想，这个Main.cst就是一个可以处理单表的生成模板了，我们只要自己写一个可以多选表的模板，然后循环调用这个模板去生成，不就完事了？</p>
<p>找了一下资料，发现只需要把上面的选项Type改一下，便可以多选表了。</p>
<p>如下：</p>
<p>&lt;%@ Property Name=”SourceTables” Type=”SchemaExplorer.TableSchemaCollection” Default=”” Optional=”False” Category=””%&gt; </p>
<p>整体代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ CodeTemplate Language=&quot;C#&quot; ResponseEncoding=&quot;UTF-8&quot; </span><br><span class="line">TargetLanguage=&quot;Text&quot; Src=&quot;&quot; Inherits=&quot;&quot; Debug=&quot;False&quot; </span><br><span class="line">Description=&quot;Template description here.&quot; Output=&quot;None&quot;%&gt;</span><br><span class="line">&lt;%@ Property Name=&quot;SourceTables&quot; </span><br><span class="line">Type=&quot;SchemaExplorer.TableSchemaCollection&quot; Default=&quot;&quot; </span><br><span class="line">Optional=&quot;False&quot; Category=&quot;&quot;%&gt; </span><br><span class="line">&lt;%@ Register Name=&quot;SE&quot; Template=&quot;CreatSingleTable.cst&quot; </span><br><span class="line">MergeProperties=&quot;False&quot; ExcludeProperties=&quot;&quot; %&gt; </span><br><span class="line">&lt;%@ Property Name=&quot;RootNamespace&quot; Default=&quot;Net.Itcast.CN&quot; </span><br><span class="line">Type=&quot;System.String&quot; Optional=&quot;False&quot;%&gt;</span><br><span class="line">&lt;%@ Assembly Name=&quot;SchemaExplorer&quot; %&gt; </span><br><span class="line">&lt;%@ Assembly Name=&quot;System.Data&quot; %&gt;</span><br><span class="line">&lt;%@ Import Namespace=&quot;SchemaExplorer&quot; %&gt; </span><br><span class="line">&lt;%@ Import Namespace=&quot;System.Data&quot; %&gt; </span><br><span class="line">&lt;%@ Import Namespace=&quot;System.Collections&quot; %&gt; </span><br><span class="line">&lt;script runat=&quot;template&quot;&gt;</span><br><span class="line">	private string _outputDirectory = String.Empty;</span><br><span class="line">	[Editor(typeof(System.Windows.Forms.Design.FolderNameEditor), </span><br><span class="line">	typeof(System.Drawing.Design.UITypeEditor))] </span><br><span class="line">	[Description(&quot;The directory to output the results to.&quot;)]</span><br><span class="line">	public string OutputDirectory </span><br><span class="line">	&#123;</span><br><span class="line">		get</span><br><span class="line">		&#123;		</span><br><span class="line">			return _outputDirectory;</span><br><span class="line">		&#125;</span><br><span class="line">		set</span><br><span class="line">		&#123;</span><br><span class="line">			if (value != null &amp;&amp; !value.EndsWith(&quot;\\&quot;))</span><br><span class="line">			&#123;</span><br><span class="line">				value += &quot;\\&quot;;</span><br><span class="line">		    &#125;</span><br><span class="line">			_outputDirectory = value;</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;% </span><br><span class="line">foreach(TableSchema ts in SourceTables) </span><br><span class="line">&#123; </span><br><span class="line">SE s = new SE(); </span><br><span class="line">   s.SourceTable = ts; </span><br><span class="line">   s.RootNamespace = RootNamespace;</span><br><span class="line">   s.OutputDirectory = OutputDirectory;</span><br><span class="line">   s.Render(this.Response); </span><br><span class="line">&#125; </span><br><span class="line">%&gt; </span><br><span class="line">&lt;script runat=&quot;template&quot;&gt; </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>前面一部分还是一样的声明，</p>
<p>&lt;%@ Property Name=”SourceTables” Type=”SchemaExplorer.TableSchemaCollection” Default=”” Optional=”False” Category=””%&gt; </p>
<p>这一句把选项类型修改成可多选的（既 集合）。<br>效果如下图：<br><img src="http://a2.qpic.cn/psb?/V13bZOxq1m5DxB/CGQI8amVPz7K7Vyb05kp*0ti3mbnPWz4Q5xdUPBQSl0!/b/dHIBAAAAAAAA&amp;bo=MQK0AjECtAIDCSw!&amp;rf=viewer_4" alt="3"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;% </span><br><span class="line">foreach(TableSchema ts in SourceTables) </span><br><span class="line">&#123; </span><br><span class="line">SE s = new SE(); </span><br><span class="line">   s.SourceTable = ts; </span><br><span class="line">   s.RootNamespace = RootNamespace;</span><br><span class="line">   s.OutputDirectory = OutputDirectory;</span><br><span class="line">   s.Render(this.Response); </span><br><span class="line">&#125; </span><br><span class="line">%&gt; </span><br><span class="line">&lt;script runat=&quot;template&quot;&gt; </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>这一段代码便是获取刚得到的表集合，遍历集合然后依次调用之前的单表生成模板。</p>
<p>到这里差不多已经完成了我要的效果，选择多表，实现一次生成所有的表对应的model/dal/bll。</p>
<p>这个效果基本就是我要的了，但是后来又发现，model里面的字段居然没有注释，我在建表的时候写了字段注释的呀。</p>
<p>打开model的cst文件之后发现，模板并没有做注释这个工作。<br>代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ CodeTemplate Language=&quot;C#&quot; TargetLanguage=&quot;C#&quot; </span><br><span class="line">Src=&quot;ToolsCodeTemplate.cs&quot; Inherits=&quot;ToolsCodeTemplate&quot;%&gt;</span><br><span class="line">&lt;%@ Property Name=&quot;TargetTable&quot; Type=&quot;SchemaExplorer.TableSchema&quot; </span><br><span class="line">Category=&quot;Context&quot; Description=&quot;TargetTable that the object is </span><br><span class="line">based on.&quot; %&gt;</span><br><span class="line">&lt;%@ Property Name=&quot;ModelsNamespace&quot; Default=&quot;Model&quot; </span><br><span class="line">Type=&quot;System.String&quot; Category=&quot;Context&quot; Description=&quot;TargetTable </span><br><span class="line">that the object is based on.&quot; %&gt;</span><br><span class="line">&lt;%@ Assembly Name=&quot;SchemaExplorer&quot; %&gt;</span><br><span class="line">&lt;%@ Assembly Name=&quot;System.Data&quot; %&gt;</span><br><span class="line">&lt;%@ Import Namespace=&quot;SchemaExplorer&quot; %&gt;</span><br><span class="line">&lt;%@ Import Namespace=&quot;System.Data&quot; %&gt;</span><br><span class="line">&lt;% PrintHeader(); %&gt;</span><br><span class="line">using System;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using System.Text;</span><br><span class="line"></span><br><span class="line">namespace &lt;%= ModelsNamespace %&gt;</span><br><span class="line">&#123;	</span><br><span class="line">	[Serializable()]</span><br><span class="line">	public class &lt;%= GetModelClassName() %&gt;</span><br><span class="line">	&#123;</span><br><span class="line">	    &lt;% </span><br><span class="line">		foreach (ColumnSchema column in TargetTable.Columns)</span><br><span class="line">	   &#123;</span><br><span class="line">		%&gt;</span><br><span class="line">			private &lt;%= GetPropertyType(column) %&gt;  _&lt;%= </span><br><span class="line">			GetPropertyName(column) %&gt;;			</span><br><span class="line">		&lt;%</span><br><span class="line">		&#125;</span><br><span class="line">		%&gt;</span><br><span class="line">	    </span><br><span class="line">		&lt;% </span><br><span class="line">		foreach (ColumnSchema column in TargetTable.Columns)</span><br><span class="line">		&#123;</span><br><span class="line">		%&gt;</span><br><span class="line">			public &lt;%= GetPropertyType(column) %&gt; &lt;%= </span><br><span class="line">			GetPropertyName(column) %&gt;</span><br><span class="line">			&#123;</span><br><span class="line">				 get &#123; return _&lt;%= GetPropertyName(column) %&gt;; &#125;</span><br><span class="line">	             set &#123; _&lt;%= GetPropertyName(column) %&gt; = value; &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&lt;%</span><br><span class="line">		&#125;</span><br><span class="line">		%&gt;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;script runat=&quot;template&quot;&gt;</span><br><span class="line">public string GetModelClassName()</span><br><span class="line">&#123;</span><br><span class="line">	return GetModelClassName(TargetTable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public override string GetFileName()</span><br><span class="line">&#123;</span><br><span class="line">	return this.GetModelClassName(this.TargetTable) + &quot;.cs&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>获取表中字段名使用的是GetPropertyName(column)，咦，在哪实现了这个东西呢？回去翻一下文件，哦，还有一个ToolsCodeTemplate.cs文一直没管呢。</p>
<p>果然，GetPropertyName(column)在这里。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public string GetPropertyName(ColumnSchema column)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    return GetNameFromDBFieldName(column);</span><br><span class="line">&#125;</span><br><span class="line">public string GetNameFromDBFieldName(ColumnSchema column)</span><br><span class="line">&#123;</span><br><span class="line">	return column.Name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>读取列名就是这么简单，那么我们对应写一个函数读取一下列注释，然后再model里面调用一下不好了。</p>
<p>又查了一下资料，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public string GetColumnComment(ColumnSchema column)</span><br><span class="line">&#123;</span><br><span class="line">     return column.Description;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>嗯，理论上这样是可以的…<br>然而，我想多了。倒腾了好久，这个属性值都是空的…<br>google了一圈之后发现，原来是SchemaExplorer.MySQLSchemaProvider.dll 里面压根没实现读取列注释的实现….</p>
<p>不过也有对应的解决方法：</p>
<p><a href="http://www.cnblogs.com/LonelyShadow/p/4147743.html" target="_blank" rel="noopener">完美解决CodeSmith无法获取MySQL表及列Description说明注释的方案</a></p>
<p>把DLL替换一下就好了。</p>
<p>最后附上模板连接:<a href="https://github.com/liguobao/CodeSmith-for-MySQL-Template" target="_blank" rel="noopener">CodeSmith-for-MySQL-Template</a></p>
<p>注：</p>
<ol>
<li>模板会把MySQL的表名前三个字符截取掉，建议把表明设置为tbl开头，或者自行修改模板文件。</li>
<li>想让字段注释生效记得替换SchemaExplorer.MySQLSchemaProvider.dll(替换前记得备份！)</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/58CityHouseSearch_move_to_aspnetcore/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/58CityHouseSearch_move_to_aspnetcore/" itemprop="url">58HouseSearch项目迁移到asp.net core</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/asp-net-core/" itemprop="url" rel="index">
                    <span itemprop="name">asp.net core</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="58HouseSearch项目迁移到asp-net-core"><a href="#58HouseSearch项目迁移到asp-net-core" class="headerlink" title="58HouseSearch项目迁移到asp.net core"></a>58HouseSearch项目迁移到asp.net core</h1><p><a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="noopener">58HouseSearch</a>这个项目原本是基于ASP.NET MVC 4写的，开发环境是Windows+VS2015，发布平台是linux+mono+jexus，这样看来整个项目基本已经满足跨平台的需求。</p>
<p>这样一来，本来我是没什么动力去做迁移的，好好的东西闲着没事干才迁移呢。</p>
<p>不过，这不国庆了么？穷人不是在家穷游天下么？所以…真的有点闲着没事干了。</p>
<h2 id="迁移可行性探讨"><a href="#迁移可行性探讨" class="headerlink" title="迁移可行性探讨"></a>迁移可行性探讨</h2><p>项目迁移前，我们还是先来讨论一下迁移可行性。为嘛要进行可行性探讨呢？原因是.NET CORE是一个跨平台的框架，和上一代的.NET存在不兼容。</p>
<p>个人总结一下，迁移的主要的问题在于：代码不兼容、类库不兼容、严重依赖Windows API或者COM组件等。</p>
<h2 id="代码不兼容"><a href="#代码不兼容" class="headerlink" title="代码不兼容"></a>代码不兼容</h2><p>代码不兼容其实不算麻烦。毕竟代码是活的，你我也是活的，不就是一个改字罢了。花点时间慢慢改，总是能搞掂的。</p>
<ul>
<li><p>类库不兼容,要不就弃用，要不就找替代品。</p>
</li>
<li><p>严重依赖Windows API或者COM组件</p>
<p>  额？找替代品，找不到可用替代品的话。放弃吧，这个项目别考虑迁移了。</p>
<p>  这个故事告诉我们，做跨平台项目的时候，少点用系统API或者组建。</p>
</li>
</ul>
<p>回到58HouseSearch项目上面。</p>
<p>这个项目的代码基本都是我写的，所以重写代码没什么问题。<br>依赖的类库有下面几个:</p>
<ul>
<li><p><a href="https://github.com/FlorianRappl/AngleSharp" target="_blank" rel="noopener">AngleSharp</a></p>
</li>
<li><p><a href="http://www.newtonsoft.com/json" target="_blank" rel="noopener">Newtonsoft.Json</a></p>
</li>
<li><p><a href="http://logging.apache.org/log4net/" target="_blank" rel="noopener">log4net</a></p>
</li>
</ul>
<p>AngleSharp是用来解析HTML的类库，用linq的方式来操作HTML，用起来实在爽快。</p>
<p>如果这货在.net core上不能跑，我应该立马放弃了。<br>不过，这个实在给力…</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/1a950803-3d38-4b16-9761-6c9cd806b0b9" alt="AngleSharp支持平台"></p>
<p>Newtonsoft.Json</p>
<p>在这个项目里面主要是用来记录PV数据的，非核心功能，可有可无。不过看了下nuget上的介绍，也是支持.net core的。</p>
<p>剩下log4net…嗯，并不支持log4net。不过这个就更加是非核心内容了，直接丢了。<br>PS:考虑后期加入Nlog替代log4net。</p>
<p>至于依赖Windows API之类的，在这个项目里面基本没有，所以略过…</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><ul>
<li><a href="https://www.visualstudio.com/downloads/" target="_blank" rel="noopener">Visual Studio Community 2015 with Update 3 – Free</a></li>
<li><a href="https://www.microsoft.com/net/download" target="_blank" rel="noopener">.NET Core SDK</a></li>
<li><a href="https://www.microsoft.com/net/download" target="_blank" rel="noopener">.NET Core</a></li>
<li><a href="https://go.microsoft.com/fwlink/?LinkId=827546" target="_blank" rel="noopener">.NET Core 1.0.1 - VS 2015 Tooling Preview 2</a></li>
</ul>
<p>友情提示：</p>
<ol>
<li>Visual Studio Community 2015 with Update 3 下载镜像来安装。</li>
</ol>
<p>错误操作如下：<br><img src="http://7xread.com1.z0.glb.clouddn.com/1e723e08-b3d5-4dab-b4a6-1de70799c4c8" alt="错误操作"></p>
<p>正确打开方式：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/706771d8-d3f2-4122-a61d-5e961887121a" alt="正确的打开方式-1"></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/455ec5cc-b429-4563-a4fb-3a0c18608969" alt="正确的打开方式-2"></p>
<ol start="2">
<li><p>安装.NET Core SDK和.NET Core之后再安装.NET Core 1.0.1 - VS 2015 Tooling Preview 2</p>
</li>
<li><p>安装.NET Core 1.0.1 - VS 2015 Tooling Preview 2 这货的可能会报错0x80072f8a未指定的错误</p>
</li>
</ol>
<p>解决方案见下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/47c517d1-4b48-4088-be4a-a0768413e768" alt="图片描述"></p>
<p>详细见链接：<a href="http://www.cnblogs.com/JiaoWoWeiZai/p/5892255.html" target="_blank" rel="noopener">安装DotNetCore.1.0.1-VS2015Tools.Preview2.0.2出现0x80072f8a未指定的错误</a></p>
<p>上面都弄好之后，理论上在VS2O15-新建项目里面可以看到ASP.NET CORE的模板了。如下图：<br><img src="http://7xread.com1.z0.glb.clouddn.com/3364e7c9-a41e-47f2-8d08-60345e4efa35" alt="ASP.NET CORE的模板"></p>
<h3 id="项目迁移"><a href="#项目迁移" class="headerlink" title="项目迁移"></a>项目迁移</h3><h4 id="新建空白ASP-NET-CORE项目"><a href="#新建空白ASP-NET-CORE项目" class="headerlink" title="新建空白ASP.NET CORE项目"></a>新建空白ASP.NET CORE项目</h4><p>新建好了之后如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/e047d81d-56f1-4e51-9d72-7989e1fc6225" alt="空白ASP.NET CORE项目"></p>
<h4 id="Nuget获取引用"><a href="#Nuget获取引用" class="headerlink" title="Nuget获取引用"></a>Nuget获取引用</h4><p><a href="https://www.nuget.org/packages/AngleSharp/" target="_blank" rel="noopener">https://www.nuget.org/packages/AngleSharp/</a></p>
<p><a href="https://www.nuget.org/packages/Newtonsoft.Json" target="_blank" rel="noopener">https://www.nuget.org/packages/Newtonsoft.Json</a></p>
<h4 id="添加Controllers文件夹"><a href="#添加Controllers文件夹" class="headerlink" title="添加Controllers文件夹"></a>添加Controllers文件夹</h4><p>然后把之前项目的Controllers拷贝过来，改掉命名空间，去掉无用代码，添加相应引用。</p>
<h4 id="添加Views文件夹"><a href="#添加Views文件夹" class="headerlink" title="添加Views文件夹"></a>添加Views文件夹</h4><p>本项目直接把之前项目的Views拷贝过来是完全没有问题的。</p>
<h4 id="静态文件处理"><a href="#静态文件处理" class="headerlink" title="静态文件处理"></a>静态文件处理</h4><p>asp.net core MVC中的文件结构和asp.net mvc的文件结构略有不同。</p>
<p>asp.net core MVC在view中“IMG/Little/PaleGreen.png”对应的文件对应于“项目路径/webroot/IMG/Little/PaleGreen.png”；</p>
<p>而asp.net mvc中，对应路径为“项目/IMG/Little/PaleGreen.png”。</p>
<p>因而，我们的所有静态文件都应该放到：webroot文件夹下。</p>
<p>上面的都做完了之后，项目结构如下：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/2fee156b-2505-4953-bfe9-1d2521f13565" alt="项目结构"></p>
<p>接下来就是改代码了。</p>
<h3 id="代码迁移"><a href="#代码迁移" class="headerlink" title="代码迁移"></a>代码迁移</h3><h4 id="Startup-cs添加MVC"><a href="#Startup-cs添加MVC" class="headerlink" title="Startup.cs添加MVC"></a>Startup.cs添加MVC</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">public class Startup</span><br><span class="line">&#123;</span><br><span class="line">    // This method gets called by the runtime. Use this method to add services to the container.</span><br><span class="line">    // For more information on how to configure your application, visit http://go.microsoft.com/fwlink/?LinkID=398940</span><br><span class="line">    public void ConfigureServices(IServiceCollection services)</span><br><span class="line">    &#123;</span><br><span class="line">        //添加MVC框架</span><br><span class="line">        services.AddMvc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // This method gets called by the runtime. Use this method to configure the HTTP request pipeline.</span><br><span class="line">    public void Configure(IApplicationBuilder app, IHostingEnvironment env,</span><br><span class="line">    ILoggerFactory loggerFactory)</span><br><span class="line">    &#123;</span><br><span class="line">        loggerFactory.AddConsole();</span><br><span class="line"></span><br><span class="line">        if (env.IsDevelopment())</span><br><span class="line">        &#123;</span><br><span class="line">            app.UseDeveloperExceptionPage();</span><br><span class="line">        &#125;</span><br><span class="line">        //启用静态文件中间件</span><br><span class="line">        app.UseStaticFiles();</span><br><span class="line">        //启动MVC路由</span><br><span class="line">        app.UseMvcWithDefaultRoute();</span><br><span class="line">        //设置默认页面</span><br><span class="line">        app.UseMvc(routes =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">            routes.MapRoute(</span><br><span class="line">                name: &quot;default&quot;,</span><br><span class="line">                template: &quot;&#123;controller=House&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;); </span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="改写GetHTMLByURL方法"><a href="#改写GetHTMLByURL方法" class="headerlink" title="改写GetHTMLByURL方法"></a>改写GetHTMLByURL方法</h4><p>之前的方法：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/d005a100-e3e6-423b-b34c-3eae11b2ab63" alt="old GetHTMLByURL"></p>
<p>.net core重写了HttpWebRequest，变成了WebRequest,所以上面的代码废了。</p>
<p>重写如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public static string GetHTMLByURL(string Url, string type = &quot;UTF-8&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    try</span><br><span class="line">    &#123;</span><br><span class="line">        Url = Url.ToLower();</span><br><span class="line"></span><br><span class="line">        System.Net.WebRequest wReq = System.Net.WebRequest.Create(Url);</span><br><span class="line">        // Get the response instance.</span><br><span class="line">        System.Net.WebResponse wResp = wReq.GetResponseAsync().Result;</span><br><span class="line">        System.IO.Stream respStream = wResp.GetResponseStream();</span><br><span class="line">        using (System.IO.StreamReader reader = new System.IO.</span><br><span class="line">        StreamReader(respStream, Encoding.GetEncoding(type)))</span><br><span class="line">        &#123;</span><br><span class="line">            return reader.ReadToEnd();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch (System.Exception ex)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        return string.Empty;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="改写Controller代码"><a href="#改写Controller代码" class="headerlink" title="改写Controller代码"></a>改写Controller代码</h4><p>嗯，换了命名空间，别的一句都没改直接拉过来了…略过。</p>
<h3 id="发布到ubuntu"><a href="#发布到ubuntu" class="headerlink" title="发布到ubuntu"></a>发布到ubuntu</h3><p><a href="https://www.microsoft.com/net/core#ubuntu" target="_blank" rel="noopener">Install for Ubuntu 14.04, 16.04 &amp; Linux Mint 17</a></p>
<p>第一步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//Ubuntu 14.04 / Linux Mint 17</span><br><span class="line">sudo sh -c <span class="string">'echo "deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ trusty main" &gt; /etc/apt/sources.list.d/dotnetdev.list'</span></span><br><span class="line">sudo apt-key adv --keyserver apt-mo.trafficmanager.net --recv-keys 417A0893</span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//Ubuntu 16.04</span><br><span class="line">sudo sh -c <span class="string">'echo "deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ xenial main" &gt; /etc/apt/sources.list.d/dotnetdev.list'</span></span><br><span class="line">sudo apt-key adv --keyserver apt-mo.trafficmanager.net --recv-keys 417A0893</span><br><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>
<p>第二步</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install dotnet-dev-1.0.0-preview2-003131</span><br></pre></td></tr></table></figure>
<p>安装好了之后，输入 dotnet -v 应该能看到版本信息，如下图：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/6ebca12e-2be9-487e-b230-d22562a5aabe" alt="dotnet -v "></p>
<p>这样的下，一句完成了ubuntu 运行asp.net core的环境搭建了。</p>
<h3 id="project-json里面隐藏的坑"><a href="#project-json里面隐藏的坑" class="headerlink" title="project.json里面隐藏的坑"></a>project.json里面隐藏的坑</h3><h4 id="dependencies"><a href="#dependencies" class="headerlink" title="dependencies"></a>dependencies</h4><p>NET Core 1.0.1 - VS 2015 Tooling Preview 2模板的asp.net core 版本和ubuntu 的asp.net core 版本不一致。</p>
<p>根据微软爸给的教程，我们在ubuntu上安装的.NET Core 1.0.0，见上图。</p>
<p>然而我们创建项目的模板是.NET Core 1.0.1，见下图:</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/a3192bdf-f548-4fad-868a-4865632acd29" alt=".NET Core 1.0.1"></p>
<p>怎么办？要不升级ubuntu的asp.net core，要不降级。</p>
<p>由于没找到.NET Core 1.0.1 ubuntu的安装包，所以我选择了降级到.NET Core 1.0.0.</p>
<p>其中需要把Microsoft.NETCore.App version 、Microsoft.AspNetCore.Server.Kestrel、Microsoft.AspNetCore.Mvc 这三个节点都改成“1.0.0”。如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">"dependencies": &#123;</span><br><span class="line">  "Microsoft.NETCore.App": &#123;</span><br><span class="line">    "version": "1.0.1",</span><br><span class="line">    "type": "platform"</span><br><span class="line">  &#125;,</span><br><span class="line">  "Microsoft.AspNetCore.Diagnostics": "1.0.0",</span><br><span class="line">  "Microsoft.AspNetCore.Server.IISIntegration": "1.0.0",</span><br><span class="line">  "Microsoft.AspNetCore.Server.Kestrel": "1.0.1",</span><br><span class="line">  "Microsoft.Extensions.Logging.Console": "1.0.0",</span><br><span class="line">  "Microsoft.AspNetCore.Mvc": "1.0.1",</span><br><span class="line">  "Microsoft.AspNetCore.StaticFiles": "1.0.0",</span><br><span class="line">  "Newtonsoft.Json": "9.0.1",</span><br><span class="line">  "AngleSharp": "0.9.8.1"</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="publishOptions"><a href="#publishOptions" class="headerlink" title="publishOptions"></a>publishOptions</h4><p>发布输出包括Views文件夹</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"publishOptions"</span>: &#123;</span><br><span class="line">  <span class="string">"include"</span>: [</span><br><span class="line">    <span class="string">"wwwroot"</span>,</span><br><span class="line">    <span class="string">"web.config"</span>,</span><br><span class="line">    <span class="string">"Views"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h4 id="runtimes"><a href="#runtimes" class="headerlink" title="runtimes"></a>runtimes</h4><p>runtimes 配置为模板运行平台。<br>详细见链接：<a href="https://docs.nuget.org/ndocs/schema/project.json" target="_blank" rel="noopener">https://docs.nuget.org/ndocs/schema/project.json</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"runtimes": &#123; "ubuntu.14.04-x64": &#123;&#125; &#125;</span><br></pre></td></tr></table></figure>
<p>上面都弄好之后，跑一下看,如下图：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dotnet restore</span><br><span class="line"></span><br><span class="line">dotnet run</span><br></pre></td></tr></table></figure>
<p>来个请求看看：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/b1191226-c33b-45c7-98cc-f62bb3ea73b4" alt="请求log"></p>
<h3 id="jexus转发-反向代理"><a href="#jexus转发-反向代理" class="headerlink" title="jexus转发/反向代理"></a>jexus转发/反向代理</h3><p><a href="http://www.cnblogs.com/gaobing/p/5663012.html" target="_blank" rel="noopener">ASP.NET Core “完整发布,自带运行时” 到jexus</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/Jexus支持HTTPS协议/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/Jexus支持HTTPS协议/" itemprop="url">Jexus支持HTTPS协议</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/jexus/" itemprop="url" rel="index">
                    <span itemprop="name">jexus</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>众所周知，在HTTPS页面请求HTTP资料的时候，现代浏览器会拦截，提示用户是否继续，或者直接拦截，提示都不出来。</p>
<p>最近给自己做了个快速书签工具，点击书签就直接把书签发送到服务器地址，然后保存到我的网站中。</p>
<p>一开始一切都挺正常的，不过遇到了https的网站的时候，就跪掉了。</p>
<p>开始的时候看到HTTPS证书是收费的，想想还是算了，反正凑合能用就是。前几天偶尔看到有一个免费申请HTTPS的开源软件，喵了一下看起来还不错，这几天有空了立马开干。下面有一个教程，我申请证书差不多就是按照这个来处理的。</p>
<p><a href="https://www.paulyang.cn/blog/archives/39?spm=5176.blog2666.yqblogcon1.12.Nu0TgL" target="_blank" rel="noopener">用Let’s Encrypt获取免费证书</a></p>
<p>关于这个Let’s Encrypt，维基百科是这样介绍的：</p>
<blockquote>
<p>Let’s Encrypt 是一个将于2015年末推出的数字证书认证机构，将通过旨在消除当前手动创建和安装证书的复杂过程的自动化流程，为安全网站提供免费的SSL/TLS证书。  Let’s Encrypt 是由互联网安全研究小组（ISRG，一个公益组织）提供的服务。主要赞助商包括电子前哨基金会，Mozilla基金会，Akamai以及思科。2015年4月9日，ISRG与Linux基金会宣布合作。用以实现这一新的数字证书认证机构的协议被称为自动证书管理环境（ACME）。  GitHub上有这一规范的草案，且提案的一个版本已作为一个Internet草案发布。Let’s Encrypt 宣称这一过程将十分简单、自动化并且免费。  2015年8月7日，该服务更新其推出计划，预计将在2015年9月7日当周某时发布首个证书，随后向列入白名单的域名发行少量证书并逐渐扩大发行。若一切按计划进行，该服务预计将在2015年11月16日当周某时全面开始提供.</p>
</blockquote>
<p>整个项目在Github有代码，主要是通过客户端来为我们的网站生成https证书。<br>首先我们先下载客户端，如下：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/letsencrypt/letsencrypt.git</span><br></pre></td></tr></table></figure></p>
<p>接着进入这个仓库内，执行下面代码：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./letsencrypt-auto certonly -a </span><br><span class="line">webroot\ --webroot-path 网站所在路径(如：/var/www/web/) \ </span><br><span class="line">-d 你的域名(如：test.online) -d www.你的域名(如ww.test.online)</span><br></pre></td></tr></table></figure></p>
<p>这里需要注意的事，我这里为了排版，给上面的命令加了换行，运行这个命令的时候记得把换行符去掉。<br>换行符在webroot、-d 前面各有一个。</p>
<p>一切顺利的话，我们在<code>/etc/letsencrypt/live/域名/</code>这个目录下能看到四个文件，分别是：</p>
<ol>
<li>域名证书文件</li>
<li>签发域名证书的证书链文件</li>
<li>域名证书+证书链文件</li>
<li>私钥文件</li>
</ol>
<p>如下图：<br><img src="http://7xread.com1.z0.glb.clouddn.com/60e4f29a-6da5-40e1-ae32-453a3bbf2455" alt="letsencrypt文件"></p>
<p>接着就是为网站设置证书了。</p>
<p>Jexus设置HTTPS要更改jws.conf文档以及网站的配置文档。</p>
<p>操作步骤如下：</p>
<ol>
<li>修改jws.conf<br>进入Jexus文件夹中，打开 “jws.conf”，添加下面两句：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CertificateFile    = /etc/letsencrypt/live/域名/fullchain.pem</span><br><span class="line">CertificateKeyFile = /etc/letsencrypt/live/域名/privkey.pem</span><br></pre></td></tr></table></figure>
<p>修改之后效果图如下：<br><img src="http://7xread.com1.z0.glb.clouddn.com/d306d9c5-6391-421d-86fc-053b97d1b489" alt="图片描述"></p>
<ol start="2">
<li>开启网站的HTTPS功能</li>
</ol>
<p>进入siteconf/文件夹，找到对应的网站conf文件，</p>
<p>把网站服务端口改为443：<br>port=443</p>
<p>启用https：<br>UseHttps=true</p>
<p>修改之后的效果图如下：<br><img src="http://7xread.com1.z0.glb.clouddn.com/0800dc87-2500-42d2-a3c5-a75a2c819330" alt="图片描述"></p>
<p>然后重启jexus即可。</p>
<p>完了之后，通过HTTPS即可访问。</p>
<p>最后上一个HTTPS证书的图证明一下这个是可行的。<br><img src="http://7xread.com1.z0.glb.clouddn.com/24842774-311e-4e55-a6b5-b88a89edc754" alt="图片描述"></p>
<p>撒花，下次再见。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/asp.net core启动方式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/asp.net core启动方式/" itemprop="url">ASP.NET Core 启动方式（Hosting）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/dotnet-core/" itemprop="url" rel="index">
                    <span itemprop="name">dotnet core</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="ASP-NET-Core-启动方式（Hosting）"><a href="#ASP-NET-Core-启动方式（Hosting）" class="headerlink" title="ASP.NET Core 启动方式（Hosting）"></a>ASP.NET Core 启动方式（Hosting）</h1><p>之前版本的ASP.NET程序必须依赖IIS来启动，而IIS上会为挂载在其中的ASP.NET 注册一个ISAPI filter。每当http请求过来时，IIS则会启动w3wp的worker process来开始整个ASP.NET runtime程序。相信大家都这样的流程都有相应的了解。在.net core之前，ASP.NET的主要场景都是运行在Windows平台的，IIS也就是web server的首选了。虽然也有类似于jexus的linux webserver可用，但是基于mono的.NET 总体还是不够Microsoft 原生的强。</p>
<p>不过到了现在，一切都不同了。</p>
<h2 id="新版ASP-NET-Core有了-NET-Core的支援后已经开始了它的跨平台之旅了，因此ASP-NET-Core的启动方式也得开始重新设计以适应新需求了。"><a href="#新版ASP-NET-Core有了-NET-Core的支援后已经开始了它的跨平台之旅了，因此ASP-NET-Core的启动方式也得开始重新设计以适应新需求了。" class="headerlink" title="新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。"></a>新版ASP.NET Core有了.NET Core的支援后已经开始了它的跨平台之旅了，因此ASP.NET Core的启动方式也得开始重新设计以适应新需求了。</h2><h3 id="1、Kestrel-和-IIS-platform-handler"><a href="#1、Kestrel-和-IIS-platform-handler" class="headerlink" title="1、Kestrel 和 IIS platform handler"></a>1、Kestrel 和 IIS platform handler</h3><p>在 ASP.NET Core 中，整个runtime都是重写过的，所以它和IIS之间的关系也有所改变。而ASP.NET Core为了跨平台，它现在的执行方式就如一般的Console app一样。ASP.NET Core自带一个高性能的I/O组件 - Kestrel，使得它可以不依赖IIS的存在便启动了runtime。不过Kestrel 也只是一个I/O组件，并没有想IIS提供其它的功能来保护和管理ASP.NET 应用程序。ASP.NET Core同样可以通过IIS进行处理。但是如果通过IIS来进行处理的话，这个时候我们便需要一个“中间人”的角色来负责这个功能了。这个“中间人”的名字叫 Http Platform Handler，主要表现在web.config文档中的设置，其中包括启动ASP.NET Core 程序的的路径和名称，需要传入的参数以及一些其他的设置选项。Http Platform Handler的具体设置例子如下：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;system.webServer&gt;</span><br><span class="line">    &lt;handlers&gt;</span><br><span class="line">      &lt;<span class="keyword">add</span> name=<span class="string">"httpPlatformHandler"</span> path=<span class="string">"*"</span> verb=<span class="string">"*"</span></span><br><span class="line">      modules=<span class="string">"httpPlatformHandler"</span> resourceType=<span class="string">"Unspecified"</span>/&gt;</span><br><span class="line">    &lt;/handlers&gt;</span><br><span class="line">    &lt;httpPlatform processPath=<span class="string">"WebApp.exe"</span> arguments=<span class="string">""</span> </span><br><span class="line">    stdoutLogEnabled=<span class="string">"false"</span> startupTimeLimit=<span class="string">"3600"</span>/&gt;</span><br><span class="line">  &lt;/system.webServer&gt;</span><br></pre></td></tr></table></figure>
<p>关于Http Platform Handler的相关资料可以看这个链接：<br><a href="http://www.iis.net/downloads/microsoft/httpplatformhandler" target="_blank" rel="noopener">http://www.iis.net/downloads/microsoft/httpplatformhandler</a></p>
<p>从上面的例子可以看出来，ASP.NET Core编译之后便是一个EXE程序，使得你可以直接运行。因此，当HTTP请求进来时，IIS先接受请求，然后根据你设置的web.config的内容将请求转发给WebApp.exe（你的ASP.NET Core程序），然后WebApp.exe开始执行时便会启动Kestrel，接着这个HTTP请求便进入了ASP.NET Core runtime的世界。这样看来，IIS这时候只是一个简单的proxy/forwarder角色。</p>
<p>PS：在我翻译整理这个文章的时候，世界已经发生了变化：下个版本的asp.net core 将会有全新的IIS module来取代Http Platform Handler。</p>
<p>具体详细资料见：<a href="https://github.com/aspnet/IISIntegration/issues/105" target="_blank" rel="noopener">https://github.com/aspnet/IISIntegration/issues/105</a></p>
<h3 id="2、Main"><a href="#2、Main" class="headerlink" title="2、Main()"></a>2、Main()</h3><p>ASP.NET Core和其他的.NET 程序一样拥有一个static void Main(),这是整个runtime的进入点。下面看一个样例：<br><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="keyword">var</span> host = <span class="keyword">new</span> WebHostBuilder()</span><br><span class="line">               .UseServer(<span class="string">"Microsoft.AspNetCore.Server.Kestrel"</span>)</span><br><span class="line">               .UseContentRoot(Directory.GetCurrentDirectory())</span><br><span class="line">               .UseDefaultConfiguration(args)</span><br><span class="line">               .UseIISPlatformHandlerUrl()</span><br><span class="line">               .UseStartup&lt;Startup&gt;()</span><br><span class="line">               .Build();</span><br><span class="line"></span><br><span class="line">           host.Run();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>ASP.NET Core host engine 的建立者是 WebHostBuilder．</p>
<p>它实质上是一个了 IWebHostBuilder interface，其中 UseServer() 是用于指定使用什么样的 server。</p>
<p>其中 UseServer() 有一个扩展方法UseServer(string assemblyName)。这样的话我们可以直接传入Kestrel的程序集名称:”Microsoft.AspNetCore.Server.Kestrel”。当然，这只是其中一种选项。你也可以自己实现一个自己的 server，只要你的 server 实现了 IServerFactory interface 即可。这样的设计提供了一个很大的弹性空间让我们自行选择hosting server（托管服务）。</p>
<h5 id="UseContentRoot"><a href="#UseContentRoot" class="headerlink" title="UseContentRoot()"></a>UseContentRoot()</h5><ul>
<li>这个扩展方法是让我们指定应用程序的工作目录（working directory），如果我们没有指定的话，则会默认为我们的应用（webapp.exe）所在目录为工作目录。</li>
</ul>
<h5 id="UseDefaultConfiguration"><a href="#UseDefaultConfiguration" class="headerlink" title="UseDefaultConfiguration()"></a>UseDefaultConfiguration()</h5><ul>
<li>这个扩展方法使得我们在IWebHostBuilder 建立可以传入一些参数，比如 application key, environment name, server factory location, content root path 等等．因此，当我们在运行 WebApp.exe 的时候，同时可以带入我们需要用到的hosting参数（PS：这样的做法就像运行命令行程序时带入参数，多好玩）。这些参数也可以写在appsettings.json里面通过Configuration来读取。<br>所以，UseDefaultConfiguration() 也不一定非要存在于 Main() 之中。（？？？个人不是很理解）</li>
</ul>
<p>PS：原作者原话，”如果我沒记错的话，在写这个文章的时候，UseDefaultConfiguration() 已经被改为成了UseDefaultHostingConfiguration()．显然这个名称更能清楚明白．”(？？？个人还没实践)</p>
<h5 id="UseIISPlatofmrHandleUrl"><a href="#UseIISPlatofmrHandleUrl" class="headerlink" title="UseIISPlatofmrHandleUrl()"></a>UseIISPlatofmrHandleUrl()</h5><ul>
<li>这个 IWebHostBuilder 的 扩展方法比较特殊。如果你要把 ASP.NET Core 放在 IIS 下，这个扩展方法会读取 IIS http platform handler 的 server port 和 application path，用于作为 ASP.NET Core 的启动位置，如 <a href="http://localhost:5000/start．如果你沒用" target="_blank" rel="noopener">http://localhost:5000/start．如果你沒用</a> IIS，这个扩展方法对你来说基本是用不上的．</li>
</ul>
<h5 id="UseStartup-lt-gt"><a href="#UseStartup-lt-gt" class="headerlink" title="UseStartup&lt;&gt;()"></a>UseStartup&lt;&gt;()</h5><ul>
<li>这是 WebHostBuilder 里相当重要的一个扩展方法。它的方法签名如下：</li>
</ul>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> IWebHostBuilder UseStartup&lt;TStartup&gt;</span><br><span class="line">(<span class="keyword">this</span> IWebHostBuilder hostBuilder) <span class="keyword">where</span> TStartup : <span class="keyword">class</span></span><br></pre></td></tr></table></figure>
<p>这里你可以很清楚地看到 &lt;&gt; 里面要放的就是一个 class。</p>
<p>在我们这里的范例中，它的名字是 Startup，里面最重要的就是需要定义要使用那些服务(service)以及要使用那些中间件(middleware)。</p>
<h3 id="3、Startup"><a href="#3、Startup" class="headerlink" title="3、Startup"></a>3、Startup</h3><p>这是一个非常非常重要的class,在ASP.NET Core范例中一般都把它命名成Startup。其实我们把它命名成其他名字也是可以的，或者设定多个Startup。上面的内容可以看到，UseStartup()指定了谁是starup class。然后在Build()便会实例化starup class，之后便执行里面两个重要的方法：ConfigureServices() 和 Configure()。</p>
<p>我们先來看 Startup 的构造函数.</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Startup</span>(<span class="params">IHostingEnvironment env</span>)</span></span><br><span class="line"><span class="function">       </span>&#123;</span><br><span class="line">           <span class="comment">// Set up configuration sources.</span></span><br><span class="line">           <span class="keyword">var</span> builder = <span class="keyword">new</span> ConfigurationBuilder()</span><br><span class="line">               .AddJsonFile(<span class="string">"appsettings.json"</span>)</span><br><span class="line">               .AddJsonFile(<span class="string">$"appsettings.<span class="subst">&#123;env.EnvironmentName&#125;</span>.json"</span>, optional: <span class="literal">true</span>)</span><br><span class="line">               .AddEnvironmentVariables();</span><br><span class="line">           Configuration = builder.Build().ReloadOnChanged(<span class="string">"appsettings.json"</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>
<p>Host engine 在被执行 Build()时已经知道 startup type 是 Startup class，所以在 Build() 的时候会先创建期示例。在我们这里的是调用Startup类带参数的构造函数。</p>
<p>在我们这个例子中选择的是传入IHostingEnvironment示例，它为我们带来了环境变量（EnvironmentName）。</p>
<p>我们这里主要目的是把Configuration实例化。这是一个蛮重要的基础组件，以后会有文章来说明它。</p>
<p>在这里我们特别说明一下，上面的示例代码中，我们执行了两次 AddJsonFile()，而且第二个json file的参数和第一个的还不太一样。这样的目的是为了让开发者可以把开发环境使用的环境参数和其他环境使用的参数有所区别。比如，你使用的开发环境用的是appsettings.json，这个文件只存在于你的电脑中。另一个文档是appsettings.production.json，这是正式环境使用的参数设定文档。第二個 AddJsonFile() 第二個参数是 true，也就是可能不存在的意思。所以若遇到重复名称参数时，appsettings.production.json 会覆盖 appsettings.json 的內容。这样使得开发环境和生产环境得以区分。</p>
<p>接下来，在 IWebHostBuilder 的 Build()里面会执行 host engine 初始化的程序，其中就会去找Startup class里面的两个方法： ConfigureServices() 和 Configure()。</p>
<p> ConfigureSerivces() 是定义了这个 web application 要使用那些服务，然后将这些服务放在 service container (IServiceCollection) 裡面。如下面的样例：</p>
 <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function">     </span>&#123;</span><br><span class="line">         <span class="comment">// add entity framework</span></span><br><span class="line">         services.AddEntityFramework()</span><br><span class="line">                 .AddDbContext&lt;BlogsContext&gt;(o =&gt; o.UseSqlServer(Configuration[<span class="string">"Data1:DefaultConnection:ConnectionString"</span>]))</span><br><span class="line">          </span><br><span class="line">         <span class="comment">// Add framework services.</span></span><br><span class="line">         services.AddMvc();</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>它定义了entity framework和mvc两个服务。这里所谓的服务（services）的意思也就是通过它们带入更庞大的程序代码。这听起来好像有点搞笑，但也真的如此。像Entity framework 里面有这么多的代码，一定都需要带入许多定义好的物件或者参数，而不只是一个程序的进去点而已，所以services 的目的就是在这里。</p>
<p>Configure() 主要是定义了中间件（middleware）以及它们的顺序．</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params">IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    loggerFactory.AddConsole(Configuration.GetSection(<span class="string">"Logging"</span>));</span><br><span class="line">    loggerFactory.AddDebug();</span><br><span class="line"></span><br><span class="line">    app.UseStaticFiles();</span><br><span class="line"></span><br><span class="line">    app.UseMvcWithDefaultRoute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4、Build-和-Run"><a href="#4、Build-和-Run" class="headerlink" title="4、Build 和 Run"></a>4、Build 和 Run</h3><p>最后，在IHostWebBuilder里最后的两个动作便是：Build and Run. </p>
<h5 id="Build"><a href="#Build" class="headerlink" title="Build()"></a>Build()</h5><ul>
<li>这个方法做的工作便是建立 hosting service，把 Startup 中定义的的 services 和 middleware 接收过来，然后确定content root path 和 application name，接着一句前面这些资料再加上Configuration过来的数据来初始化host engine (WebHost.cs)．</li>
</ul>
<h5 id="Run"><a href="#Run" class="headerlink" title="Run()"></a>Run()</h5><ul>
<li>这个是启动 host engine 的 扩展方法，它在启动之前加入了一个 CancelKeyPress 的事件．因为在 Run() 方法 中传入入了 CancellationTokenSource() ，让我们有一个方法可以随时中断host engine的执行。</li>
</ul>
<p>目前的做法就用是 CancelKeyPress 事件，所以你可以按下 Ctrl+C  來中止 host engine 的执行．</p>
<p>比较特別的是，这一段中止的文字说明居然是用 hard code，參考如下:</p>
<p>host.Run(cts.Token, “Application started. Press Ctrl+C to shut down.”);</p>
<p>不过这样的话，这里你也不能写中文…</p>
<p>全文差不多就这样了，原文在这里：<a href="https://dotblogs.com.tw/aspnetshare/2016/03/28/20160327" target="_blank" rel="noopener">ASP.NET Core 的啟動方式 (Hosting)</a></p>
<p>感谢ASP.NET Core 資訊分享。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://codelover.link/2016/10/04/58CityHouseSearch-JS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="李国宝">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="codelover的异想天开">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/04/58CityHouseSearch-JS/" itemprop="url">58同城高德搜房项目JS相关知识</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-04T00:00:00+08:00">
                2016-10-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/JavaScript/" itemprop="url" rel="index">
                    <span itemprop="name">JavaScript</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="58同城高德搜房项目JS相关知识"><a href="#58同城高德搜房项目JS相关知识" class="headerlink" title="58同城高德搜房项目JS相关知识"></a>58同城高德搜房项目JS相关知识</h1><p>在线地址：<a href="http://codelover.link:8080/">58同城品牌公寓高德搜房</a></p>
<p>Github地址：<a href="https://github.com/liguobao/58HouseSearch" target="_blank" rel="noopener">https://github.com/liguobao/58HouseSearch</a></p>
<p>知乎专栏(点赞用的)：<a href="https://zhuanlan.zhihu.com/p/21960329" target="_blank" rel="noopener">高德API+Python解决租房问题(.NET版)</a></p>
<p>经过了一个星期的修补补，以及小伙伴风险的代码，整个项目基本处于基本稳定运行的状态。</p>
<p>同时加入了一下新功能：</p>
<ol>
<li>IP定位：调用高德地图IP定位功能实现</li>
<li>移动地图中心定位：调用高德地图移动地图定位实现</li>
<li>定位城市名转58同城城市名以获得准确58同城城市域名：抓取58同城城市分类信息</li>
<li>优化数据源、去除广告数据：小伙伴奉献代码</li>
</ol>
<p>今天主要简单讲解一下其中使用的一些高德地图API接口。</p>
<h2 id="高德地图JavaScript-API-主体为map对象，基本所有的操作都是通过map对象来实现的。"><a href="#高德地图JavaScript-API-主体为map对象，基本所有的操作都是通过map对象来实现的。" class="headerlink" title="高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。"></a>高德地图JavaScript API 主体为map对象，基本所有的操作都是通过map对象来实现的。</h2><p>map对象实例化是通过 Amap类来做的。如以下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">map = <span class="keyword">new</span> AMap.Map(<span class="string">"container"</span>, &#123;</span><br><span class="line">        resizeEnable: <span class="literal">true</span>,</span><br><span class="line">        zoomEnable: <span class="literal">true</span>,</span><br><span class="line">        center: [<span class="number">121.297428</span>, <span class="number">31.1345</span>],<span class="comment">//经纬度，此处为上海</span></span><br><span class="line">        zoom: <span class="number">11</span></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="IP定位"><a href="#IP定位" class="headerlink" title="IP定位"></a>IP定位</h2><p>调用Map.CitySearch()获得当前IP所在城市，直接将地图显示成当前城市。代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showCityInfo</span>(<span class="params">map</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//实例化城市查询类</span></span><br><span class="line">    <span class="keyword">var</span> citysearch = <span class="keyword">new</span> AMap.CitySearch();</span><br><span class="line">    <span class="comment">//自动获取用户IP，返回当前城市</span></span><br><span class="line">    citysearch.getLocalCity(<span class="function"><span class="keyword">function</span> (<span class="params">status, result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (status === <span class="string">'complete'</span> &amp;&amp; result.info === <span class="string">'OK'</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; result.city &amp;&amp; result.bounds) &#123;</span><br><span class="line">                <span class="keyword">var</span> cityinfo = result.city;<span class="comment">//获得XX市</span></span><br><span class="line">                <span class="keyword">var</span> citybounds = result.bounds;<span class="comment">//用于设置地图显示位置的实例</span></span><br><span class="line">                cityName = cityinfo.substring(<span class="number">0</span>, cityinfo.length - <span class="number">1</span>);<span class="comment">//去掉市这个字</span></span><br><span class="line">                ConvertCityCNNameToShortCut();<span class="comment">//城市名转换成58同城城市域名字母，如上海-&gt;sh,苏州-&gt;su,</span></span><br><span class="line">                                              <span class="comment">//下面会有实现代码</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">document</span>.getElementById(<span class="string">'IPLocation'</span>).innerHTML = <span class="string">'您当前所在城市：'</span> + cityName;</span><br><span class="line">                <span class="comment">//地图显示当前城市</span></span><br><span class="line">                map.setBounds(citybounds);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">document</span>.getElementById(<span class="string">'IPLocation'</span>).innerHTML = result.info;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="移动地图自动中心定位"><a href="#移动地图自动中心定位" class="headerlink" title="移动地图自动中心定位"></a>移动地图自动中心定位</h2><p>之前有一版是让用户输入城市名，然后直接定位到输入的城市的。<br>这个功能卡在了设置地图显示位置上，如果是使用高德地图提供的搜索控件的话，又存在输入结果之后搜索结果可能是多个的问题。而且这点我只是要取到用户想要定位的城市而已，感觉没必要做得太复杂。<br>昨晚在看高德地图API的时候发现，有一个移动地图获得地图中心所在位置的样例，马上眼前一亮了。这个功能比我想要的还要好…果断上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MapMoveToLocationCity</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    map.on(<span class="string">'moveend'</span>, getCity);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getCity</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        map.getCity(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (data[<span class="string">'province'</span>] &amp;&amp; <span class="keyword">typeof</span> data[<span class="string">'province'</span>] === <span class="string">'string'</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> cityinfo = (data[<span class="string">'city'</span>] || data[<span class="string">'province'</span>]);</span><br><span class="line">                cityName = cityinfo.substring(<span class="number">0</span>, cityinfo.length - <span class="number">1</span>);</span><br><span class="line">                ConvertCityCNNameToShortCut();<span class="comment">//城市名转58同城地区域名</span></span><br><span class="line"></span><br><span class="line">                <span class="built_in">document</span>.getElementById(<span class="string">'IPLocation'</span>).innerHTML = <span class="string">'地图中心所在城市：'</span> + cityName;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个代码的意思是，给map绑定一下移动时间，移动完了之后，调用getCity的方法获取当前地图中心所在城市信息。</p>
<p>这个时候要注意，城市名可能在city对象里面，也可能在province里面。</p>
<p>原因很简单：普通城市等级就是城市，我国还存在一个和省份一个等级的城市：直辖市。因此直辖市的城市名是在province里面的。</p>
<h2 id="城市名匹配58同城地区域名"><a href="#城市名匹配58同城地区域名" class="headerlink" title="城市名匹配58同城地区域名"></a>城市名匹配58同城地区域名</h2><p>这个是上个版本(两三天前)的一个bug引出来的新功能。</p>
<p>上个版本是让用户输入城市名，然后提取城市名的中文拼音首字母作为58同城地区域名。如上海 =sh，广州=gz，北京=bj，成都=cd。</p>
<p>这个功能使用的是网上别人写的一个JS库，通过汉字匹配实现的。转换出来的数据没什么问题，不过我国汉字实在奥妙。</p>
<p>广州=gz，赣州=gz；<br>遂宁=sn；绥宁=sn；<br>惠州=hz，杭州=hz。</p>
<p>这样一来，上面这个做法就没法玩了。</p>
<p>想了下怎么解决这个问题，灵机一动。反正是在爬58的数据，这个城市名和城市域名数据58同城肯定有啊，然后找到了这个。<br><a href="http://www.58.com/changecity.aspx?PGTID=0d100000-0007-a77b-4c4b-a28f725b8f5a&amp;ClickID=1" target="_blank" rel="noopener">58同城城市分类导航</a></p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/c01c293a-d5cc-4f58-80dc-13aa05d47b01" alt="123"></p>
<p>很明显，我要的所有城市名和城市域名都是里面了。</p>
<p>晚上和衣衣说了下，衣衣一大早就把处理好的json数据给我了。</p>
<p>于是来了下面一段代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//加载json文件</span></span><br><span class="line">$.getJSON(<span class="string">"DomainJS/city.json"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">      allCityInfo = data;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ConvertCityCNNameToShortCut</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> filterarray = $.grep(allCityInfo, <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> obj.cityName == cityName;</span><br><span class="line">    &#125;);<span class="comment">//找到当前城市名对应的json对象</span></span><br><span class="line">    <span class="comment">//获取json对象的地区域名</span></span><br><span class="line">    cityNameCNPY = filterarray <span class="keyword">instanceof</span> <span class="built_in">Array</span> ? </span><br><span class="line">    filterarray[<span class="number">0</span>].shortCut : filterarray != <span class="literal">null</span> ? filterarray.shortCut : <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="高德地图自动补全功能"><a href="#高德地图自动补全功能" class="headerlink" title="高德地图自动补全功能"></a>高德地图自动补全功能</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"control-input"</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"work-location"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">style</span>=<span class="string">"width:60%"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> auto = <span class="keyword">new</span> AMap.Autocomplete(&#123;</span><br><span class="line">       input: <span class="string">"work-location"</span></span><br><span class="line">   &#125;);</span><br><span class="line"></span><br><span class="line">   AMap.event.addListener(auto, <span class="string">"select"</span>, workLocationSelected);</span><br></pre></td></tr></table></figure>
<p>看方法前面也知道，其实这就是把ID为work-location的input初始化为地图插件，然后给Amap增加了一个监听事件。<br>当其中选中某一个数据的时候，触发workLocationSelected函数。效果如下：</p>
<p><img src="http://7xread.com1.z0.glb.clouddn.com/fe425992-e7c4-4cae-800e-319eff3b17e8" alt="2233"></p>
<p>在这里locationSelected是定位到所选位置，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLocationSelected</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">    workAddress = e.poi.name;</span><br><span class="line">    loadWorkLocation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadWorkLocation</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    delWorkLocation();</span><br><span class="line">    <span class="keyword">var</span> geocoder = <span class="keyword">new</span> AMap.Geocoder(&#123;</span><br><span class="line">        city: cityName,</span><br><span class="line">        radius: <span class="number">1000</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    geocoder.getLocation(workAddress, <span class="function"><span class="keyword">function</span> (<span class="params">status, result</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (status === <span class="string">"complete"</span> &amp;&amp; result.info === <span class="string">'OK'</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> geocode = result.geocodes[<span class="number">0</span>];</span><br><span class="line">            x = geocode.location.getLng();</span><br><span class="line">            y = geocode.location.getLat();</span><br><span class="line">            loadWorkMarker(x, y);</span><br><span class="line">            loadWorkRange(x, y, <span class="number">60</span>, <span class="string">"#3f67a5"</span>, vehicle);</span><br><span class="line">            map.setZoomAndCenter(<span class="number">12</span>, [x, y]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至于导航功能代码我没怎么动，没去研究就不献丑了…</p>
<p>最后来个效果图。</p>
<h3 id="北京"><a href="#北京" class="headerlink" title="北京"></a>北京</h3><p><img src="http://7xread.com1.z0.glb.clouddn.com/e7900aba-5a56-417c-9dd9-63527583e84b" alt="123"></p>
<h3 id="成都"><a href="#成都" class="headerlink" title="成都"></a>成都</h3><p><img src="http://7xread.com1.z0.glb.clouddn.com/c9947d97-1b76-42bf-82b3-aca817e84e13" alt="333"></p>
<h3 id="苏州"><a href="#苏州" class="headerlink" title="苏州"></a>苏州</h3><p><img src="http://7xread.com1.z0.glb.clouddn.com/941809ae-aa37-4a3b-89c7-10646cc7e3e7" alt="233"></p>
<h3 id="深圳"><a href="#深圳" class="headerlink" title="深圳"></a>深圳</h3><p><img src="http://7xread.com1.z0.glb.clouddn.com/86712397-27ec-4b37-bbf8-81191e530ef6" alt="233"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">李国宝</p>
              <p class="site-description motion-element" itemprop="description">一只打算吃软饭的软狗</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/liguobao" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:codelover@qq.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://https://www.zhihu.com/people/codelover" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://codesky.me/" title="CodeSky 代码之空" target="_blank">CodeSky 代码之空</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.1234.sh/" title="あまみや ゆうこ" target="_blank">あまみや ゆうこ</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">李国宝</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
